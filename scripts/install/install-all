#!/usr/bin/env bash
set -euo pipefail
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Parse args
WITH_NIX=false
for arg in "$@"; do
  case "$arg" in
    --with-nix) WITH_NIX=true ;;
    --help|-h)
      echo "Usage: install-all [--with-nix]"
      echo "  --with-nix  Install Nix and Home Manager (bootstrap from scratch)"
      exit 0
      ;;
  esac
done

# Ensure ~/.bin and link hm-add if present in repo
mkdir -p "$HOME/.bin"
if [ -f "$ROOT/.bin/hm-add" ]; then
  ln -sf "$ROOT/.bin/hm-add" "$HOME/.bin/hm-add"
  chmod +x "$HOME/.bin/hm-add"
  echo "✔ Linked hm-add to ~/.bin/hm-add"
fi

# Install GNOME+i3 session files
"$ROOT/scripts/install/install-gnome-i3"

# Install Claude Code configuration
"$ROOT/scripts/install/install-claude-config"

# Install Nix + Home Manager (if requested)
if [ "$WITH_NIX" = true ]; then
  "$ROOT/scripts/install/install-nix-hm"
fi

echo "✅ install-all complete."
