#!/usr/bin/env bash
# install-nix-hm: Bootstrap Nix and Home Manager from scratch
#
# This script:
# 1. Installs Nix using the Determinate Systems installer (if not present)
# 2. Deploys the home-manager config from this repo
# 3. Runs home-manager switch to activate the configuration
#
# Safe to re-run: skips steps that are already complete.

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
HM_CONFIG_SRC="$REPO_ROOT/.config/home-manager"
HM_CONFIG_DEST="$HOME/.config/home-manager"

echo "=== Nix + Home Manager Bootstrap ==="
echo "Repo: $REPO_ROOT"
echo "HM config source: $HM_CONFIG_SRC"
echo "HM config dest: $HM_CONFIG_DEST"
echo

# Step 1: Install Nix if not present
if command -v nix &>/dev/null; then
    echo "✔ Nix already installed: $(nix --version)"
else
    echo "Installing Nix via Determinate Systems installer..."
    curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm

    # Source nix in current shell
    if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    fi

    echo "✔ Nix installed"
fi

# Verify nix is available
if ! command -v nix &>/dev/null; then
    echo "ERROR: Nix not found in PATH after installation."
    echo "Try starting a new shell or run:"
    echo "  . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
    exit 1
fi

# Step 2: Deploy home-manager config
if [ ! -d "$HM_CONFIG_SRC" ]; then
    echo "ERROR: Home Manager config not found at $HM_CONFIG_SRC"
    exit 1
fi

mkdir -p "$(dirname "$HM_CONFIG_DEST")"

if [ -L "$HM_CONFIG_DEST" ]; then
    CURRENT_TARGET="$(readlink -f "$HM_CONFIG_DEST")"
    EXPECTED_TARGET="$(readlink -f "$HM_CONFIG_SRC")"
    if [ "$CURRENT_TARGET" = "$EXPECTED_TARGET" ]; then
        echo "✔ Home Manager config already symlinked"
    else
        echo "WARNING: $HM_CONFIG_DEST points to $CURRENT_TARGET"
        echo "Expected: $EXPECTED_TARGET"
        echo "Updating symlink..."
        rm "$HM_CONFIG_DEST"
        ln -s "$HM_CONFIG_SRC" "$HM_CONFIG_DEST"
        echo "✔ Symlink updated"
    fi
elif [ -d "$HM_CONFIG_DEST" ]; then
    echo "WARNING: $HM_CONFIG_DEST exists as a directory"
    echo "Backing up to ${HM_CONFIG_DEST}.bak and replacing with symlink..."
    mv "$HM_CONFIG_DEST" "${HM_CONFIG_DEST}.bak"
    ln -s "$HM_CONFIG_SRC" "$HM_CONFIG_DEST"
    echo "✔ Backed up and symlinked"
else
    ln -s "$HM_CONFIG_SRC" "$HM_CONFIG_DEST"
    echo "✔ Symlinked home-manager config"
fi

# Step 3: Initialize git repo in HM config (required for flakes)
cd "$HM_CONFIG_DEST"
if [ ! -d .git ] && [ ! -f .git ]; then
    # Check if it's part of a larger repo (dotfiles)
    if git rev-parse --is-inside-work-tree &>/dev/null; then
        echo "✔ Home Manager config is part of git repo"
    else
        echo "Initializing git repo in home-manager config..."
        git init
        git add .
        git commit -m "Initial home-manager config"
        echo "✔ Git repo initialized"
    fi
fi

# Step 4: Run home-manager switch
echo
echo "Running home-manager switch..."
echo "(This may take a while on first run as it downloads packages)"
echo

nix run github:nix-community/home-manager -- switch --flake "$HM_CONFIG_DEST"

echo
echo "=== Bootstrap Complete ==="
echo
echo "Home Manager is now active. You may need to start a new shell"
echo "for all environment changes to take effect."
echo
echo "Useful commands:"
echo "  hm-add <pkg>     - Add a package"
echo "  hm-update        - Update all packages"
echo "  hm-list          - List installed packages"
