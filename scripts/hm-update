#!/usr/bin/env bash
# hm-update: update Home Manager flake inputs and rebuild.
# - With no args: updates all flake inputs
# - With args: updates only specified inputs (e.g., nixpkgs, home-manager)
#
# Note: In Nix flakes, you update *inputs* (nixpkgs, home-manager), not individual
# packages. All packages come from nixpkgs, so updating nixpkgs updates all packages.

set -euo pipefail

HM_DIR="${HM_DIR:-$HOME/.config/home-manager}"
cd "$HM_DIR"

print_help() {
  cat <<'EOF'
Usage:
  hm-update                     Update all flake inputs and rebuild
  hm-update <input> [<input>..] Update specific inputs only (e.g., nixpkgs)
  hm-update --list              List available flake inputs
  hm-update --help | -h         Show this help

Examples:
  hm-update                     # Update everything
  hm-update nixpkgs             # Update only nixpkgs (all packages)
  hm-update home-manager        # Update only home-manager
  hm-update nixpkgs home-manager # Update both

Note: In Nix flakes, packages come from the nixpkgs input. To get newer
versions of packages, update nixpkgs. There's no per-package update.
EOF
}

list_inputs() {
  echo "Available flake inputs:"
  nix flake metadata --json 2>/dev/null | jq -r '.locks.nodes | keys[] | select(. != "root")' 2>/dev/null || \
    nix flake info 2>/dev/null | grep -E '^\s+\w+:' | awk '{print $1}' | tr -d ':'
}

# Parse args
if [[ "${1:-}" =~ ^(--help|-h)$ ]]; then
  print_help
  exit 0
fi

if [[ "${1:-}" == "--list" ]]; then
  list_inputs
  exit 0
fi

# Ensure we're in a git repo
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "Error: $HM_DIR is not a Git repo"
  exit 1
fi

# Update inputs
if [[ $# -eq 0 ]]; then
  echo "Updating all flake inputs..."
  nix flake update
  COMMIT_MSG="flake.lock: update all inputs"
else
  INPUTS=("$@")
  echo "Updating flake inputs: ${INPUTS[*]}..."
  for input in "${INPUTS[@]}"; do
    nix flake lock --update-input "$input"
  done
  COMMIT_MSG="flake.lock: update ${INPUTS[*]}"
fi

# Rebuild
echo "Rebuilding Home Manager config..."
nix run github:nix-community/home-manager -- switch --flake .

# Commit only if flake.lock changed
if ! git diff --quiet flake.lock 2>/dev/null; then
  git add flake.lock
  git commit -m "$COMMIT_MSG ($(date +%F))"
  echo "Committed flake.lock update"
else
  echo "No changes to flake.lock"
fi

echo "Done."
